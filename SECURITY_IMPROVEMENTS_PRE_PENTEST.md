# Security Improvements - Pre-Penetration Test

**Date**: 2025-11-11  
**Status**: Pre-deployment testing required  
**Risk Level**: Low (additive changes, no breaking changes to auth flow)

---

## Overview

This document outlines security enhancements applied to Curriculum Studio prior to the scheduled penetration test on November 18, 2025. These changes address critical vulnerabilities while maintaining the existing Supabase authentication flow that was recently stabilized.

---

## Changes Implemented

### 1. Backend API Authentication (JWT Verification)

**Problem**: Backend endpoints were accessible without authentication, allowing anyone with the backend URL to make API calls.

**Solution**: Implemented JWT token verification using Supabase Auth.

**Files Modified**:
- `backend/app/api/dependencies.py` - New file with `verify_supabase_jwt()` and `get_current_user()` dependencies
- `backend/app/core/config.py` - Added `supabase_url` and `supabase_anon_key` settings
- `backend/pyproject.toml` - Added `supabase` client library dependency
- `backend/config/settings.env.template` - Added Supabase configuration template

**Protected Endpoints**:
- `POST /api/chat/query` - Full research pipeline
- `POST /api/chat/quick-qa` - Fast Q&A
- `POST /api/documents` - Document upload
- `GET /api/documents` - List documents
- `POST /api/secrets` - Store API keys

**Unprotected Endpoints** (intentionally public):
- `GET /api/health` - Health check

**How It Works**:
1. Frontend sends JWT access token in `Authorization: Bearer <token>` header
2. Backend calls `supabase.auth.get_user(token)` to verify
3. If valid, request proceeds with user context
4. If invalid/missing, returns `401 Unauthorized`

---

### 2. Test Endpoints Disabled in Production

**Problem**: Test endpoints (`/api/test/*`) were accessible in production, exposing debug information.

**Solution**: Added environment check to return 404 for test endpoints when `APP_ENV=production`.

**Files Modified**:
- `backend/app/api/routes/test_endpoint.py` - Added `check_test_endpoints_enabled()` dependency

**Affected Endpoints**:
- `GET /api/test/simple`
- `GET /api/test/with-db`
- `GET /api/test/with-graph`
- `POST /api/test/with-run`

---

### 3. Input Validation Enhanced

**Problem**: Minimal validation on user inputs, potential for oversized requests or malformed data.

**Solution**: Added Pydantic field validators with length limits and whitespace stripping.

**Files Modified**:
- `backend/app/schemas/chat.py` - Added max_length constraints and field validators
- `backend/app/api/routes/secrets.py` - Added max_length to API key field

**Validation Rules**:
- `question`: 1-5000 characters, whitespace trimmed
- `history`: Max 50 turns per conversation
- `content`: Max 50,000 characters per history turn
- `model`: Max 100 characters, whitespace trimmed
- `secret_token`: Max 100 characters
- `api_key`: 10-500 characters

---

### 4. Frontend JWT Token Management

**Problem**: Frontend wasn't sending JWT tokens to backend API.

**Solution**: Updated `APIClient` to automatically include JWT token in requests.

**Files Modified**:
- `frontend/utils/api_client.py` - Added `set_auth_token()` and `clear_auth_token()` methods, updated `get_api_client()` to auto-configure tokens

**How It Works**:
1. `get_api_client()` reads `st.session_state.sb_access_token`
2. Sets `Authorization: Bearer <token>` header on all requests
3. Token is automatically refreshed by existing auth flow
4. No caching to prevent token leakage between users

---

## What Was NOT Changed

To avoid breaking the recently fixed authentication flow:

1. **Streamlit Auth Flow**: No changes to `frontend/auth.py` token storage or validation logic
2. **Supabase Client Initialization**: No changes to `frontend/utils/supabase_client.py`
3. **Frontend Session Management**: Token refresh logic remains unchanged
4. **Database Schema**: No migrations or schema changes
5. **Deployment Configuration**: No Render or Streamlit Cloud settings changed

---

## Environment Variables Required

### Backend (`backend/config/settings.env`)

Add these four new variables for multi-project authentication:

```env
# Curriculum Studio Supabase
SUPABASE_CURRICULUM_URL=https://rqhpxwlsrgbxsqgpmolc.supabase.co
SUPABASE_CURRICULUM_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxaHB4d2xzcmdieHNxZ3Btb2xjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzQ2MzMsImV4cCI6MjA3ODQ1MDYzM30.QqYPOK6lw5GdvSGdfTm1SyqFoP_U2KfQD0EnavisAR4

# Aethelgard Academy Supabase
SUPABASE_AETHELGARD_URL=https://ufslljdxdldxdknbcpjw.supabase.co
SUPABASE_AETHELGARD_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmc2xsamR4ZGxkeGRrbmJjcGp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NzIyODIsImV4cCI6MjA3ODM0ODI4Mn0.Hoo23Vrdkbpk368rRCSY3RmeCVu6tT6Vql__KX9DYQ8
```

**Note**: The backend now supports JWT authentication from both Curriculum Studio and Aethelgard Academy Supabase projects, allowing both apps to securely share the same AXIS AI backend.

### Frontend (no changes)

Frontend already has Supabase credentials in Streamlit secrets - no additional configuration needed.

---

## Testing Checklist

### Local Testing (Before Push)

- [ ] Install new dependencies: `cd backend && poetry install`
- [ ] Add `SUPABASE_URL` and `SUPABASE_ANON_KEY` to `backend/config/settings.env`
- [ ] Start backend: `cd backend && poetry run python run_server.py`
- [ ] Verify health check still works: `curl http://localhost:8000/api/health`
- [ ] Verify test endpoints return 404 if `APP_ENV=production`:
  ```bash
  APP_ENV=production poetry run python run_server.py
  curl http://localhost:8000/api/test/simple
  # Should return 404
  ```
- [ ] Test protected endpoint without auth (should fail):
  ```bash
  curl -X POST http://localhost:8000/api/chat/quick-qa \
    -H "Content-Type: application/json" \
    -d '{"question": "test"}'
  # Should return 401 Unauthorized
  ```
- [ ] Start frontend: `cd frontend && streamlit run app.py`
- [ ] Log in as admin user
- [ ] Test AXIS AI Chat (should work with JWT auth)
- [ ] Test Generate Content (should work with JWT auth)
- [ ] Check browser console for no 401 errors

### Render Deployment Testing

- [ ] Push to GitHub
- [ ] Wait for Render auto-deploy (~2-3 minutes)
- [ ] Check Render logs for startup errors
- [ ] Set `SUPABASE_URL` and `SUPABASE_ANON_KEY` in Render environment variables
- [ ] Restart service after env vars added
- [ ] Test from Streamlit Cloud:
  - [ ] Log in successfully
  - [ ] Send a quick Q&A message
  - [ ] Verify response is received
  - [ ] Check for no 401 errors in Network tab

---

## Rollback Plan

If issues arise after deployment:

1. **Via Render Dashboard**:
   - Go to https://dashboard.render.com
   - Select `qnc-curriculum-studio` service
   - Click "Manual Deploy" → Select previous deploy from dropdown
   - Click "Deploy"

2. **Via Git**:
   ```bash
   git log --oneline  # Find commit before security changes
   git revert <commit-hash>
   git push origin master
   ```

3. **Emergency Quick Fix**:
   - Comment out `current_user: dict = Depends(get_current_user)` from all endpoints
   - Push to GitHub
   - Render will auto-deploy in 2-3 minutes

---

## Risk Assessment

### Low Risk Changes
- ✅ Input validation (Pydantic catches errors, doesn't break functionality)
- ✅ Test endpoint disabling (only affects unused debug endpoints)
- ✅ Frontend token sending (already available in session state)

### Medium Risk Changes
- ⚠️ JWT verification (could block requests if token invalid/missing)
  - **Mitigation**: Comprehensive local testing before push
  - **Fallback**: Rollback takes 2-3 minutes
  - **Impact if broken**: Users can't access chat/generate features

---

## Known Limitations

These items are NOT addressed by this change set (documented for pen tester):

1. **Streamlit Secrets Storage**: Service role key still in Streamlit secrets (architectural decision)
2. **Admin Panel Frontend Checks**: Role verification happens in frontend (will be hardened post-pentest)
3. **Rate Limiting**: Not yet implemented (future enhancement)
4. **CORS Headers**: Still accepts all methods/headers from whitelisted origins

---

## Post-Deployment Monitoring

After deployment, monitor for:

1. **Render Logs**: Check for authentication errors
   ```
   Log into Render → qnc-curriculum-studio → Logs tab
   Search for: "auth.missing_header", "auth.invalid_token", "401"
   ```

2. **Streamlit Cloud Errors**: Check Streamlit app for 401 responses
   ```
   Browser DevTools → Network tab → Filter: "api"
   Look for red (failed) requests with status 401
   ```

3. **User Reports**: If users report "can't send messages", check JWT token in session state:
   ```python
   # In Streamlit app, add debug panel temporarily:
   st.write("Access token:", st.session_state.get("sb_access_token", "MISSING"))
   ```

---

## Success Criteria

Changes are considered successful if:

1. ✅ Users can log in (no regression in auth flow)
2. ✅ Chat/Generate features work (API calls succeed with JWT)
3. ✅ Test endpoints return 404 in production
4. ✅ No 401 errors in browser console during normal usage
5. ✅ Health check endpoint remains accessible without auth

---

## Contact for Issues

If problems arise during testing or deployment:

- **Primary**: User (application owner)
- **Backup**: Check `SECURITY_IMPROVEMENTS_PRE_PENTEST.md` rollback section
- **Emergency**: Revert to commit before security changes via Render dashboard

---

**End of Document**

